<html>
<head>
  <title>Pokedex</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --card: #0f3460;
      --accent: #e94560;
      --text: #eee;
      --muted: #a0a0b0;
      --radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }

    .header {
      background: var(--surface);
      border-bottom: 2px solid var(--accent);
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .header h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
    .header h1 span { color: var(--accent); }
    .header .count { color: var(--muted); font-size: 0.85rem; margin-left: auto; }

    .controls { max-width: 1100px; margin: 1.5rem auto; padding: 0 1.5rem; }
    .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .search-bar input {
      flex: 1; padding: 0.6rem 1rem; border: 2px solid #333;
      border-radius: var(--radius); background: var(--surface);
      color: var(--text); font-size: 0.95rem; outline: none;
      transition: border-color 0.2s;
    }
    .search-bar input:focus { border-color: var(--accent); }
    .search-bar input::placeholder { color: var(--muted); }

    .type-filters { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .type-btn {
      padding: 0.3rem 0.7rem; border-radius: 999px;
      font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.04em; border: 2px solid transparent;
      cursor: pointer; transition: all 0.15s; color: #fff;
    }
    .type-btn:hover { opacity: 0.85; transform: translateY(-1px); }
    .type-btn.active { border-color: #fff; box-shadow: 0 0 8px rgba(255,255,255,0.3); }

    .grid-container { max-width: 1100px; margin: 0 auto; padding: 0 1.5rem 2rem; }
    .pokemon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--card); border-radius: var(--radius);
      padding: 1.25rem; cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative; overflow: hidden;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .card-id {
      position: absolute; top: 0.75rem; right: 0.75rem;
      color: rgba(255,255,255,0.2); font-size: 1.5rem; font-weight: 800;
    }
    .card-name { font-size: 1.15rem; font-weight: 700; margin-bottom: 0.5rem; }
    .card-types { display: flex; gap: 0.35rem; margin-bottom: 0.75rem; }
    .type-badge {
      padding: 0.2rem 0.55rem; border-radius: 999px;
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.03em; color: #fff;
    }
    .card-stats {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 0.25rem 0.75rem; font-size: 0.8rem;
    }
    .stat { display: flex; justify-content: space-between; }
    .stat-label { color: var(--muted); }
    .stat-val { font-weight: 600; }
    .legendary-badge {
      display: inline-block;
      background: linear-gradient(135deg, #f8d030, #f08030);
      color: #333; font-size: 0.65rem; font-weight: 700;
      padding: 0.15rem 0.45rem; border-radius: 999px;
      margin-left: 0.4rem; vertical-align: middle; text-transform: uppercase;
    }

    .pagination {
      display: flex; justify-content: center; align-items: center;
      gap: 0.5rem; margin-top: 1.5rem; padding-bottom: 1rem;
    }
    .page-btn {
      padding: 0.4rem 0.9rem; border-radius: var(--radius);
      background: var(--surface); color: var(--text); border: 2px solid #333;
      cursor: pointer; font-size: 0.85rem; transition: all 0.15s;
    }
    .page-btn:hover:not(:disabled) { border-color: var(--accent); }
    .page-btn:disabled { opacity: 0.3; cursor: default; }
    .page-btn.current { background: var(--accent); border-color: var(--accent); font-weight: 600; }
    .page-info { color: var(--muted); font-size: 0.85rem; }

    .detail {
      max-width: 500px; margin: 2rem auto;
      background: var(--card); border-radius: var(--radius); padding: 2rem;
    }
    .detail-header {
      display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 1rem;
    }
    .detail-name { font-size: 2rem; font-weight: 800; }
    .detail-id { color: var(--muted); font-size: 1.1rem; }
    .detail-types { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .detail-types .type-badge { font-size: 0.85rem; padding: 0.3rem 0.75rem; }
    .stat-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.6rem; }
    .stat-row-label {
      width: 70px; font-size: 0.8rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .stat-bar-bg {
      flex: 1; height: 10px; background: rgba(255,255,255,0.1);
      border-radius: 999px; overflow: hidden;
    }
    .stat-bar { height: 100%; border-radius: 999px; transition: width 0.4s ease; }
    .stat-row-val { width: 35px; text-align: right; font-weight: 700; font-size: 0.9rem; }
    .back-link {
      display: inline-block; margin-bottom: 1rem;
      color: var(--accent); font-weight: 600; font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    .empty { text-align: center; padding: 3rem 1rem; color: var(--muted); }
    .empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .htmx-request .pokemon-grid { opacity: 0.5; transition: opacity 0.15s; }
  </style>
</head>
<body>

{# ── Reusable components via {% def %} ─────────────────────────── #}

{% globals %}

{% def type_badge(t) %}
{% spaceless %}
<span class="type-badge" style="background: {{ t | type_color }}">{{ t }}</span>
{% end %}
{% end %}

{% def stat_bar(label, val) %}
{% let pct = val * 100 // 160 %}
{% let color = "" %}
{% match true %}
  {% case val >= 100 %}{% set color = "#e94560" %}
  {% case val >= 70 %}{% set color = "#f8d030" %}
  {% case _ %}{% set color = "#6890f0" %}
{% end %}
<div class="stat-row">
  <span class="stat-row-label">{{ label }}</span>
  <div class="stat-bar-bg">
    <div class="stat-bar" style="width: {{ pct }}%; background: {{ color }};"></div>
  </div>
  <span class="stat-row-val">{{ val }}</span>
</div>
{% end %}

{% def pokemon_card(p) %}
<a href="/pokemon/{{ p.id }}" hx-get="/pokemon/{{ p.id }}" hx-target="#main" hx-push-url="true"
   hx-select="#main">
<div class="card">
  <span class="card-id">#{{ p.id }}</span>
  <div class="card-name">
    {{ p.name | capitalize }}
    {% if p.legendary %}<span class="legendary-badge">Legendary</span>{% end %}
  </div>
  <div class="card-types">
    {% for t in p.types.split(",") %}{{ type_badge(t) }}{% end %}
  </div>
  <div class="card-stats">
    {% for label, val in [("HP", p.hp), ("ATK", p.attack), ("DEF", p.defense), ("SPD", p.speed)] %}
    <div class="stat"><span class="stat-label">{{ label }}</span> <span class="stat-val">{{ val }}</span></div>
    {% end %}
  </div>
</div>
</a>
{% end %}

{% end %}{# globals #}

{# ── Header ─────────────────────────────────────────────────────── #}

<div class="header">
  <h1><span>Poke</span>dex</h1>
  <div class="view-controls" style="display:flex;gap:0.4rem;margin-left:1rem;">
    <button class="type-btn" style="background:#555;"
            hx-get="/" hx-target="#main" hx-push-url="true"
            hx-vals='{"view": "grid"}'>Grid View</button>
    <button class="type-btn" style="background:#555;"
            hx-get="/" hx-target="#main" hx-push-url="true"
            hx-vals='{"view": "list"}'>List View</button>
  </div>
  <span class="count">{{ total ?? "" }}{{ " Pokemon" if total is defined else "" }}</span>
</div>

<div id="main">
{# ── Detail view ────────────────────────────────────────────────── #}

{% block pokemon_detail %}
{% if detail is defined and detail %}
<div class="grid-container" style="margin-top: 1.5rem;">
  <a href="/" class="back-link" hx-get="/" hx-target="#main" hx-push-url="true">&larr; Back to all</a>
  <div class="detail">
    <div class="detail-header">
      <span class="detail-name">{{ detail.name | capitalize }}</span>
      <span class="detail-id">#{{ detail.id }}</span>
      {% if detail.legendary %}
      <span class="legendary-badge">Legendary</span>
      {% end %}
    </div>
    <div class="detail-types">
      {% for t in detail.types.split(",") %}{{ type_badge(t) }}{% end %}
    </div>
    {% for label, val in [("HP", detail.hp), ("Attack", detail.attack), ("Defense", detail.defense), ("Speed", detail.speed)] %}
    {{ stat_bar(label, val) }}
    {% end %}
    <div style="margin-top: 1.25rem; font-size: 0.85rem; color: var(--muted);">
      Generation {{ detail.generation }}
    </div>
  </div>
</div>
{% end %}
{% endblock %}

{# ── Grid view ──────────────────────────────────────────────────── #}

{% block pokemon_grid %}
<div class="controls">
  <div class="search-bar">
    <input type="search"
           name="q"
           placeholder="Search Pokemon..."
           value="{{ search ?? '' }}"
           hx-get="/"
           hx-target="#main"
           hx-trigger="input changed delay:300ms, search"
           hx-push-url="true"
           hx-include=".type-btn.active"
           autocomplete="off">
  </div>
  {% cache "type-filters" %}
  <div class="type-filters">
    <button class="type-btn {{ 'active' if not current_type else '' }}"
            style="background: #555;"
            hx-get="/"
            hx-target="#main"
            hx-push-url="true"
            hx-include="[name=q]">All</button>
    {% for t in all_types %}
    <button class="type-btn {{ 'active' if current_type == t else '' }}"
            name="type"
            value="{{ t }}"
            style="background: {{ t | type_color }}"
            hx-get="/?type={{ t }}"
            hx-target="#main"
            hx-push-url="true"
            hx-include="[name=q]">{{ t }}</button>
    {% end %}
  </div>
  {% end %}{# cache #}
</div>

<div class="grid-container">
  {% unless pokemon %}
  <div class="empty">
    <div class="empty-icon">?</div>
    <p>No Pokemon found{% if search %} matching "{{ search }}"{% end %}{% if current_type %} of type {{ current_type }}{% end %}.</p>
  </div>
  {% else %}
  <div class="pokemon-grid">
    {% for p in pokemon %}
    {{ pokemon_card(p) }}
    {% end %}
  </div>

  {% if total_pages > 1 %}
  {% let base = "" %}
  {% if current_type %}{% set base = "&type=" + current_type %}{% end %}
  {% if search %}{% set base = base + "&q=" + search %}{% end %}

  {# Infinite scroll sentinel — loads next page when scrolled into view.
     Uses hx-trigger="revealed" (htmx's native infinite scroll pattern).
     Falls back to manual pagination buttons below for accessibility. #}
  {% if page < total_pages %}
  <div hx-get="/?page={{ page + 1 }}{{ base }}"
       hx-trigger="revealed"
       hx-target=".pokemon-grid"
       hx-swap="beforeend"
       hx-select=".pokemon-grid > *"
       style="height:1px;"></div>
  {% end %}

  <div class="pagination">
    <button class="page-btn"
            hx-get="/?page={{ page - 1 }}{{ base }}"
            hx-target="#main"
            hx-push-url="true"
            {% if page <= 1 %}disabled{% end %}>&laquo; Prev</button>
    <span class="page-info">{{ page }} / {{ total_pages }}</span>
    <button class="page-btn"
            hx-get="/?page={{ page + 1 }}{{ base }}"
            hx-target="#main"
            hx-push-url="true"
            {% if page >= total_pages %}disabled{% end %}>Next &raquo;</button>
  </div>
  {% end %}
  {% end %}{# unless #}
</div>
{% endblock %}
</div>{# #main #}

</body>
</html>
