{# Blocks for RAG demo — sources, answer, ask_result, empty_question
   Uses chirp-ui container, grid, card, streaming_block.
   Custom SSE: sources + answer + share_link swap targets. hx-disinherit isolates from boost. #}
{% from "chirpui/layout.html" import container, grid %}
{% from "chirpui/streaming.html" import copy_btn %}

{% block sources %}
<div class="sources chirpui-stack chirpui-stack--sm" sse-swap="sources" hx-target="this">
  <h2 class="chirpui-font-lg" style="font-size: var(--chirpui-font-lg);">Sources used to draft this answer</h2>
  {% if sources %}
  <p class="chirpui-text-muted" style="color: var(--chirpui-text-muted);">Similar articles retrieved and passed to the model:</p>
  <div class="sources-list chirpui-stack chirpui-stack--sm">
  {% for doc in sources %}
  <div class="source-item chirpui-card" style="padding: var(--chirpui-spacing);">
    <a href="{{ doc.url }}" target="_blank" rel="noopener" class="source-link">{{ doc.title }}</a>
    <p class="source-snippet chirpui-text-muted" style="color: var(--chirpui-text-muted); font-size: var(--chirpui-font-sm);">{{ doc.content | truncate(150) }}</p>
  </div>
  {% end %}
  </div>
  {% else %}
  <p class="sources-empty chirpui-text-muted" style="color: var(--chirpui-text-muted);">No matching docs found.</p>
  {% end %}
</div>
{% end %}

{% block answer %}
<div class="answer-body chirpui-streaming-block{% if streaming %} chirpui-streaming-block--active{% end %}"
     {% if not streaming %}data-copy-text="{{ text | e }}"{% end %}
     aria-live="polite" aria-atomic="true">
  {% if streaming %}
  {% if rendered_html is defined %}
  <div class="chirpui-prose">{{ rendered_html | safe }}</div>
  {% if in_progress %}<span class="streaming-raw">{{ in_progress | e }}</span>{% end %}
  {% else %}
  <pre class="streaming-text">{{ text | e }}</pre>
  {% end %}
  <span class="chirpui-streaming-block__cursor" aria-hidden="true"></span>
  {% else %}
  <div class="chirpui-prose">{{ text | markdown | cite(sources) | safe(reason="patitas output") }}</div>
  {{ copy_btn(label="Copy", copy_text=text) }}
  {% end %}
</div>
{% end %}

{% block ask_result %}
{% call container() %}
<article class="chirpui-card"
         hx-ext="sse"
         sse-connect="{{ stream_url }}"
         sse-close="done"
         hx-disinherit="hx-target hx-swap"
         aria-label="Question and answer">
  <header class="chirpui-card__header">
    <span class="chirpui-text-muted" style="color: var(--chirpui-text-muted); font-size: var(--chirpui-font-sm);">Question</span>
    <p class="chirpui-font-lg" style="font-size: var(--chirpui-font-lg); margin: 0;">{{ question }}</p>
    <button type="button" class="chirpui-copy-btn" title="Refine this question"
            hx-on::click="var q=this.closest('.chirpui-card').querySelector('p');if(q){document.getElementById('question-input').value=q.textContent;document.getElementById('question-input').focus()}">
      Refine
    </button>
  </header>
  <div class="chirpui-card__body chirpui-stack chirpui-stack--lg">
    {% block sources %}{% end %}
    <div>
      <span class="chirpui-text-muted" style="color: var(--chirpui-text-muted); font-size: var(--chirpui-font-sm);">Answer</span>
      <div sse-swap="answer" hx-target="this" aria-live="polite" aria-atomic="true">
        <span class="chirpui-text-muted">Searching docs and generating answer…</span>
        <span class="chirpui-streaming-block__cursor" aria-hidden="true"></span>
      </div>
      <div sse-swap="share_link" hx-target="this"></div>
    </div>
  </div>
</article>
{% end %}
{% end %}

{% block share_link %}
{% if share_id and share_url %}
<a href="{{ share_url }}" target="_blank" rel="noopener" class="share-link">Share this Q&A</a>
{% end %}
{% end %}

{% block ask_compare_result %}
{% call container() %}
<div class="chirpui-grid chirpui-grid--cols-2">
  <article class="chirpui-card chirpui-model-card"
           hx-ext="sse"
           sse-connect="{{ stream_url_a }}"
           sse-close="done"
           hx-disinherit="hx-target hx-swap"
           aria-label="Question and answer ({{ model_a }})">
    <header class="chirpui-card__header chirpui-model-card__header">
      <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">Question</span>
      <p class="chirpui-model-card__title" style="margin: 0;">{{ question }}</p>
    </header>
    <div class="chirpui-card__body chirpui-stack chirpui-stack--lg">
      <div class="sources chirpui-stack chirpui-stack--sm" sse-swap="sources" hx-target="this">
        <h2 class="chirpui-font-lg" style="font-size: var(--chirpui-font-lg);">Sources</h2>
        {% if sources %}
        <div class="sources-list chirpui-stack chirpui-stack--sm">
        {% for doc in sources %}
        <div class="source-item chirpui-card" style="padding: var(--chirpui-spacing);">
          <a href="{{ doc.url }}" target="_blank" rel="noopener">{{ doc.title }}</a>
          <p class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">{{ doc.content | truncate(150) }}</p>
        </div>
        {% end %}
        </div>
        {% else %}
        <p class="chirpui-text-muted">No matching docs found.</p>
        {% end %}
      </div>
      <div>
        <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">{{ model_a }}</span>
        <div sse-swap="answer" hx-target="this" aria-live="polite" aria-atomic="true">
          <span class="chirpui-text-muted">Generating…</span>
          <span class="chirpui-streaming-block__cursor" aria-hidden="true"></span>
        </div>
        <div sse-swap="share_link" hx-target="this"></div>
      </div>
    </div>
  </article>
  <article class="chirpui-card chirpui-model-card"
           hx-ext="sse"
           sse-connect="{{ stream_url_b }}"
           sse-close="done"
           hx-disinherit="hx-target hx-swap"
           aria-label="Question and answer ({{ model_b }})">
    <header class="chirpui-card__header chirpui-model-card__header">
      <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">Question</span>
      <p class="chirpui-model-card__title" style="margin: 0;">{{ question }}</p>
    </header>
    <div class="chirpui-card__body chirpui-stack chirpui-stack--lg">
      <div class="sources chirpui-stack chirpui-stack--sm" sse-swap="sources" hx-target="this">
        <h2 class="chirpui-font-lg" style="font-size: var(--chirpui-font-lg);">Sources</h2>
        {% if sources %}
        <div class="sources-list chirpui-stack chirpui-stack--sm">
        {% for doc in sources %}
        <div class="source-item chirpui-card" style="padding: var(--chirpui-spacing);">
          <a href="{{ doc.url }}" target="_blank" rel="noopener">{{ doc.title }}</a>
          <p class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">{{ doc.content | truncate(150) }}</p>
        </div>
        {% end %}
        </div>
        {% else %}
        <p class="chirpui-text-muted">No matching docs found.</p>
        {% end %}
      </div>
      <div>
        <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">{{ model_b }}</span>
        <div sse-swap="answer" hx-target="this" aria-live="polite" aria-atomic="true">
          <span class="chirpui-text-muted">Generating…</span>
          <span class="chirpui-streaming-block__cursor" aria-hidden="true"></span>
        </div>
        <div sse-swap="share_link" hx-target="this"></div>
      </div>
    </div>
  </article>
</div>
{% end %}
{% end %}

{% block ask_batch_result %}
{% call container() %}
<div class="chirpui-stack chirpui-stack--lg">
{% for question, sources, stream_url in items %}
<article class="chirpui-card"
         hx-ext="sse"
         sse-connect="{{ stream_url }}"
         sse-close="done"
         hx-disinherit="hx-target hx-swap"
         aria-label="Question and answer">
  <header class="chirpui-card__header">
    <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">Question</span>
    <p class="chirpui-font-lg" style="margin: 0;">{{ question }}</p>
    <button type="button" class="chirpui-copy-btn" title="Refine this question"
            hx-on::click="var q=this.closest('.chirpui-card').querySelector('p');if(q){document.getElementById('question-input').value=q.textContent;document.getElementById('question-input').focus()}">
      Refine
    </button>
  </header>
  <div class="chirpui-card__body chirpui-stack chirpui-stack--lg">
    <div class="sources chirpui-stack chirpui-stack--sm" sse-swap="sources" hx-target="this">
      <h2 class="chirpui-font-lg" style="font-size: var(--chirpui-font-lg);">Sources used to draft this answer</h2>
      {% if sources %}
      <p class="chirpui-text-muted">Similar articles retrieved and passed to the model:</p>
      <div class="sources-list chirpui-stack chirpui-stack--sm">
      {% for doc in sources %}
      <div class="source-item chirpui-card" style="padding: var(--chirpui-spacing);">
        <a href="{{ doc.url }}" target="_blank" rel="noopener">{{ doc.title }}</a>
        <p class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">{{ doc.content | truncate(150) }}</p>
      </div>
      {% end %}
      </div>
      {% else %}
      <p class="chirpui-text-muted">No matching docs found.</p>
      {% end %}
    </div>
    <div>
      <span class="chirpui-text-muted" style="font-size: var(--chirpui-font-sm);">Answer</span>
      <div sse-swap="answer" hx-target="this" aria-live="polite" aria-atomic="true">
        <span class="chirpui-text-muted">Searching docs and generating answer…</span>
        <span class="chirpui-streaming-block__cursor" aria-hidden="true"></span>
      </div>
      <div sse-swap="share_link" hx-target="this"></div>
    </div>
  </div>
</article>
{% end %}
</div>
{% end %}
{% end %}

{% block empty_question %}
<div id="validation" hx-swap-oob="true">
  <p class="validation-msg">Please enter a question.</p>
</div>
{% end %}
