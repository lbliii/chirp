{#- Kanban Board — main template (standalone, like contacts/dashboard).

    Kida features showcased:
    - {% globals %}         — shared imports available in full render + render_block()
    - {% fragment %}        — OOB-only blocks, skipped during full page render
    - {% from...import %}   — component imports from separate templates
    - {% call %} + {% slot %} — column component with caller content
    - {% let %}             — scoped computed variables
    - {% unless %}          — negated conditionals
    - {% cache %}           — fragment caching for stats
    - | selectattr          — filter by attribute
    - | map(attribute=)     — extract field values
    - | unique              — deduplicate
    - | compact             — remove None values
    - | sort(attribute=)    — sort within columns
    - | length              — counts
    - | lower, | capitalize — string transforms
    - loop.index, is odd    — alternating card tints
-#}

{# Fragment-safe imports — available during both render() and render_block(). #}
{% imports %}
  {% from "components/_card.html" import task_card %}
  {% from "components/_column.html" import column %}
  {% from "components/_field.html" import field %}
{% end %}

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kanban Board</title>
  <link rel="stylesheet" href="/static/board.css">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
</head>
<body>
<div class="app-layout">

  {# ================================================================
     Header with stats
     ================================================================ #}
  <header class="app-header">
    <h1>Kanban Board</h1>
    <img id="board-spinner" class="htmx-indicator" src="/static/spinner.svg" alt="" style="width:1.2rem;height:1.2rem;">
    {% block header_stats %}
    <div id="board-stats" class="stats" hx-swap-oob="outerHTML">
      {% cache "board-stats", ttl=30 %}
      <span><strong>{{ all_tasks | length }}</strong> tasks</span>
      <span><strong>{{ all_tasks | selectattr("priority", "equalto", "high") | list | length }}</strong> high priority</span>
      {% let assignees = all_tasks | map(attribute="assignee") | compact | unique | list %}
      <span><strong>{{ assignees | length }}</strong> people</span>
      {% end %}
    </div>
    {% end %}
    {% let user = current_user() %}
    <div class="user-info">
      <span class="avatar">{{ user.name | first | upper }}</span>
      <span class="name">{{ user.name }}</span>
      <form method="post" action="/logout" style="margin:0">
        {{ csrf_field() }}
        <button type="submit" class="btn-logout">Logout</button>
      </form>
    </div>
  </header>

  {# ================================================================
     Filter sidebar — {% let %}, | map, | compact, | unique, | sort
     ================================================================ #}
  <aside class="sidebar">
    <h3>Priority</h3>
    {% for p in ["high", "medium", "low"] %}
      <label>
        <input type="checkbox" name="priority" value="{{ p }}"
               {{ "checked" if p in active_filters.priority else "" }}
               hx-get="/filter" hx-target="#board" hx-swap="outerHTML"
               hx-include=".sidebar input">
        {{ p | capitalize }}
      </label>
    {% end %}

    <h3>Assignee</h3>
    {% let all_assignees = all_tasks | map(attribute="assignee") | compact | unique | sort | list %}
    {% unless all_assignees %}
      <p class="muted">No assignees.</p>
    {% end %}
    {% for person in all_assignees %}
      <label>
        <input type="checkbox" name="assignee" value="{{ person }}"
               {{ "checked" if person in active_filters.assignee else "" }}
               hx-get="/filter" hx-target="#board" hx-swap="outerHTML"
               hx-include=".sidebar input">
        {{ person }}
      </label>
    {% end %}

    <h3>Tags</h3>
    {% let all_tags = all_tasks | map(attribute="tags") | sum(start=()) | unique | sort | list %}
    {% unless all_tags %}
      <p class="muted">No tags yet.</p>
    {% end %}
    {% for tag in all_tags %}
      <label>
        <input type="checkbox" name="tag" value="{{ tag }}"
               {{ "checked" if tag in active_filters.tag else "" }}
               hx-get="/filter" hx-target="#board" hx-swap="outerHTML"
               hx-include=".sidebar input">
        {{ tag }}
      </label>
    {% end %}
  </aside>

  {# ================================================================
     Main content — board + add form
     ================================================================ #}
  <div class="main-content">

    {# --- Full board: 4 columns via {% call column() %} --- #}
    {% block board %}
    <div id="board" class="board">
      {% for col_id, col_name in columns %}
        {% let col_tasks = board.get(col_id, []) %}
        {% call column(col_id, col_name, col_tasks | length, oob=false) %}
          {% unless col_tasks %}
            <p class="empty">No tasks in {{ col_name | lower }}.</p>
          {% end %}
          {% for task in col_tasks | sort(attribute="created_at") %}
            {% if loop.index is odd %}
            <div class="card-wrapper alt">
            {% else %}
            <div class="card-wrapper">
            {% end %}
              {{ task_card(task) }}
            </div>
          {% end %}
        {% end %}
      {% end %}
    </div>
    {% end %}

    {# --- Quick-add form --- #}
    {% block add_form %}
    <form class="add-form" hx-post="/tasks" hx-swap="none"
          hx-indicator="#board-spinner" hx-disabled-elt="find button">
      {{ field("title", "Task", placeholder="What needs doing?") }}
      <div class="form-field">
        <label for="field-status">Column</label>
        <select id="field-status" name="status">
          {% for col_id, col_name in columns %}
          <option value="{{ col_id }}">{{ col_name }}</option>
          {% end %}
        </select>
      </div>
      <div class="form-field">
        <label for="field-priority">Priority</label>
        <select id="field-priority" name="priority">
          {% for p in ["low", "medium", "high"] %}
          <option value="{{ p }}" {{ "selected" if p == "medium" else "" }}>
            {{ p | capitalize }}
          </option>
          {% end %}
        </select>
      </div>
      {{ field("assignee", "Assignee", placeholder="Name (optional)", required=false) }}
      {{ field("tags", "Tags", placeholder="Comma-separated", required=false) }}
      <button type="submit">Add Task</button>
    </form>
    {% if errors is defined and errors %}
    <ul class="form-errors">
      {% for fld, msgs in errors.items() %}
        {% for msg in msgs %}
        <li>{{ fld | capitalize }}: {{ msg }}</li>
        {% end %}
      {% end %}
    </ul>
    {% end %}
    {% end %}

  </div>

</div>

{# SSE connection for live updates #}
<div hx-ext="sse" sse-connect="/events">
  <div sse-swap="fragment" style="display:none;"></div>
</div>

{# Toast for delete notifications — uses htmx.process() to activate any
   hx-* attributes on dynamically inserted toast content (e.g. an "Undo" button). #}
<div id="toast" class="toast"></div>

{# Undo area — listens for taskDeleted event via hx-trigger (htmx-native bridging) #}
<div id="undo-area"
     hx-get="/tasks/last-deleted"
     hx-trigger="taskDeleted from:body"
     hx-target="this"
     hx-swap="innerHTML">
</div>

<script>
  {# Send CSRF token with every htmx request via X-CSRF-Token header #}
  document.body.addEventListener("htmx:configRequest", function(event) {
    var meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) { event.detail.headers["X-CSRF-Token"] = meta.content; }
  });

  document.body.addEventListener("taskDeleted", function() {
    var t = document.getElementById("toast");
    t.textContent = "Task deleted.";
    t.classList.add("show");
    setTimeout(function() { t.classList.remove("show"); }, 2000);

    {# htmx.process() — activate htmx on any hx-* attributed elements
       that were injected into the toast via innerHTML (outside htmx's swap). #}
    htmx.process(t);
  });

  {# htmx.trigger() — bridge JS events to htmx declarative listeners.
     Instead of: document.dispatchEvent(new CustomEvent('taskDeleted', ...))
     Use htmx native: htmx.trigger(document.body, 'taskDeleted', {}) #}
</script>

{# ==================================================================
   Fragment blocks for OOB rendering (skipped during full page render,
   available via render_block() for OOB swaps and SSE events).
   Imports are provided by {% globals %} at the top of the template.
   ================================================================== #}

{# Single column — rendered for OOB swaps when tasks move #}
{% fragment column_block %}
{% if column_id is defined %}
{% call column(column_id, column_name, tasks | length) %}
  {% unless tasks %}
    <p class="empty">No tasks.</p>
  {% end %}
  {% for task in tasks | sort(attribute="created_at") %}
    {% if loop.index is odd %}
    <div class="card-wrapper alt">
    {% else %}
    <div class="card-wrapper">
    {% end %}
      {{ task_card(task) }}
    </div>
  {% end %}
{% end %}
{% end %}
{% endfragment %}

{# Single task card — rendered for OOB swap after edit #}
{% fragment task_card_block %}
{% if task is defined %}
<div id="task-{{ task.id }}" hx-swap-oob="outerHTML">
  {{ task_card(task) }}
</div>
{% end %}
{% endfragment %}

</body>
</html>
