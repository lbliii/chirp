{% globals %}
{% def chat_message(msg) %}
{% spaceless %}
<div class="msg">
  <span class="msg-user">{{ msg.username | capitalize }}</span>
  <span class="msg-text">{{ msg.text }}</span>
  <span class="msg-time">{{ msg.timestamp | timeago }}</span>
</div>
{% end %}
{% end %}
{% end %}
<html>
<head>
  <title>Chat Room</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f172a; color: #e2e8f0;
      min-height: 100vh; max-width: 600px; margin: 0 auto; padding: 1.5rem;
    }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; color: #f8fafc; }
    .info { color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem; }
    #messages {
      background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem;
      padding: 1rem; height: 400px; overflow-y: auto;
      display: flex; flex-direction: column; gap: 0.25rem;
    }
    .msg { padding: 0.25rem 0; }
    .msg-user { font-weight: 600; color: #60a5fa; }
    .msg-text { margin-left: 0.25rem; color: #e2e8f0; }
    .msg-time { color: #64748b; font-size: 0.75rem; margin-left: 0.5rem; }
    .empty-chat { color: #64748b; font-style: italic; padding: 2rem; text-align: center; }
    #send-form { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    #send-form input {
      flex: 1; padding: 0.5rem 0.75rem; font-size: 1rem;
      background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem;
      color: #e2e8f0;
    }
    #send-form input::placeholder { color: #64748b; }
    #send-form button {
      padding: 0.5rem 1rem; cursor: pointer;
      background: #3b82f6; color: #fff; border: none; border-radius: 0.5rem;
    }
    #send-form button:hover { background: #2563eb; }
  </style>
</head>
<body>
<h1>Chat Room</h1>
<p class="info">Logged in as <strong>{{ username ?? 'Anonymous' }}</strong></p>

<div id="messages"
     hx-ext="sse"
     sse-connect="/chat/events"
     sse-swap="fragment"
     hx-swap="beforeend">
  {% unless messages %}
  <p class="empty-chat">No messages yet. Say something!</p>
  {% else %}
  {% for msg in messages %}
  {% block message %}
  {{ chat_message(msg) }}
  {% endblock %}
  {% end %}
  {% end %}
</div>

<form id="send-form"
      hx-post="/chat/send"
      hx-swap="none"
      hx-sync="this:abort"
      hx-disabled-elt="#send-btn"
      hx-on::after-request="this.reset()">
  <input type="text" name="message" placeholder="Type a message..." autocomplete="off" autofocus>
  <button id="send-btn" type="submit">Send</button>
</form>

<script>
  {# Auto-scroll + remove empty placeholder on first message #}
  const el = document.getElementById("messages");
  new MutationObserver(() => {
    const empty = el.querySelector(".empty-chat");
    if (empty) empty.remove();
    el.scrollTop = el.scrollHeight;
  }).observe(el, { childList: true });
</script>
</body>
</html>
